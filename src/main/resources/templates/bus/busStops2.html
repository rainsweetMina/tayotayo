<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layout/layout.html}" lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë²„ìŠ¤ ì •ë¥˜ì¥ ëª©ë¡</title>

    <!-- ì¹´ì¹´ì˜¤ë§µ SDK ë¡œë“œ -->
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=fab0be4fd1cec021de71529983c6c88c"></script>
</head>

<body>
<div layout:fragment="content" style="">
    <!-- ì§€ë„ í‘œì‹œ ì˜ì—­ -->
    <div id="map" style="width:100%; height:850px;"></div>

    <br>
    <button onclick="panTo()">ì§€ë„ ì¤‘ì‹¬ ë¶€ë“œëŸ¬ìš´ ì´ë™</button>
<!--    <button id="currentLocationBtn">í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™</button>-->
<!--    <button onclick="resizeMap()">ì§€ë„ í¬ê²Œ ë³´ê¸°</button>-->
<!--    <button onclick="relayout()">ìƒˆë¡œê³ ì¹¨</button>-->

    <script>
        kakao.maps.load(function () {
            // ì§€ë„ ìƒì„±
            let mapContainer = document.getElementById('map'),
                mapOption = {
                    center: new kakao.maps.LatLng(35.8668, 128.5940), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
                    level: 3 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
                };

            let map = new kakao.maps.Map(mapContainer, mapOption);

            /*-ë²„ìŠ¤ ì •ë¥˜ì¥ ë§ˆì»¤ í‘œì‹œ-*/



            // ì§€ë„ ì»¨íŠ¸ë¡¤ ì¶”ê°€
            let mapTypeControl = new kakao.maps.MapTypeControl();
            map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

            let zoomControl = new kakao.maps.ZoomControl();
            map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

            map.addOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC);

            // ì „ì—­ ì ‘ê·¼ì„ ìœ„í•´ map ê°ì²´ë¥¼ window.kakaoMapì— ì €ì¥
            window.kakaoMap = map;

            /*-- í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™ --*/
            // document.getElementById('currentLocationBtn').addEventListener('click', function () {
            //     if (navigator.geolocation) {
            //         navigator.geolocation.getCurrentPosition(function (position) {
            //             let lat = position.coords.latitude;
            //             let lon = position.coords.longitude;
            //             let moveLatLon = new kakao.maps.LatLng(lat, lon);
            //             kakaoMap.setCenter(moveLatLon);
            //
            //             // í˜„ì¬ ìœ„ì¹˜ì— ë§ˆì»¤ ì¶”ê°€
            //             new kakao.maps.Marker({
            //                 position: moveLatLon,
            //                 map: kakaoMap
            //             });
            //
            //         }, function () {
            //             console.error('ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
            //         });
            //     } else {
            //         console.error('ë¸Œë¼ìš°ì €ì—ì„œ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            //     }
            // });

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    let lat = position.coords.latitude;
                    let lon = position.coords.longitude;
                    let moveLatLon = new kakao.maps.LatLng(lat, lon);
                    kakaoMap.setCenter(moveLatLon);

                    // // í˜„ì¬ ìœ„ì¹˜ì— ë§ˆì»¤ ì¶”ê°€
                    // new kakao.maps.Marker({
                    //     position: moveLatLon,
                    //     map: kakaoMap
                    // });

                }, function () {
                    console.error('ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
                });
            } else {
                console.error('ë¸Œë¼ìš°ì €ì—ì„œ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        });

        // ì „ì—­ í•¨ìˆ˜ë¡œ ì •ì˜
        function panTo() {
            let moveLatLon = new kakao.maps.LatLng(35.8668, 128.5940);
            kakaoMap.panTo(moveLatLon);
        }

        /*--ì§€ë„ í¬ê²Œ ë³´ê¸° --*/
        // function resizeMap() {
        //     let mapContainer = document.getElementById('map');
        //     mapContainer.style.width = '650px';
        //     mapContainer.style.height = '650px';
        // }


        /*-ì§€ë„ ìƒˆë¡œê³ ì¹¨-*/
        // function relayout() {
        //     // ì „ì—­ kakaoMap ë³€ìˆ˜ë¥¼ ì°¸ì¡°í•˜ì—¬ relayout í˜¸ì¶œ
        //     window.kakaoMap.relayout();
        // }

        // í˜„ì¬ ë„£ì€ê¸°ëŠ¥
        // 1. ì§€ë„ì— ì»¨íŠ¸ë¡¤ëŸ¬ ì˜¬ë¦¬ê¸°
        // 2. ì¤‘ì‹¬ìœ„ì¹˜ ì´ë™
        // 3. í˜„ì¬ìœ„ì¹˜
        // 4. êµí†µ í˜¼ì¡ë„
        // 5. ì§€ë„ í¬ê¸°ë³´ê¸°

        // ì¶”ê°€ ì°¾ì•„ë³¼ê¸°ëŠ¥(ë– ì˜¤ë¥´ëŠ”)
        //     ì§€ë„ìœ„ì¹˜ ì›€ì§ì´ë©´ ê°€ì¥ ê°€ê¹Œìš´ ì •ë¥˜ì¥ í‘œì‹œ(ê°€ëŠ¥í• ì§€? ì°¾ì•„ë´¤ì§€ë§Œ ìš°ì„  ì‹¤íŒ¨)


        // ê²€ìƒ‰í•˜ë©´ ê²€ìƒ‰ëœ ì •ë¥˜ì¥ì— ë§ˆì»¤ê°€ ì°íˆê³  ì²«ë²ˆì§¸ë¡œ ë‚˜ì˜¨ ì •ë¥˜ì†Œë¡œ í™”ë©´ ì´ë™
        document.addEventListener("busStopsUpdated", function () {
            if (window.selectedBusStops && window.selectedBusStops.length > 0) {
                console.log("ğŸ—ºï¸ ì§€ë„í˜ì´ì§€ - ê²€ìƒ‰ëœ ì •ë¥˜ì†Œ ë§ˆì»¤ í‘œì‹œ ì‹œì‘!");

                //  ê¸°ì¡´ ë§ˆì»¤ ì§€ìš°ê¸°
                if (window.busStopMarkers) {
                    window.busStopMarkers.forEach(marker => marker.setMap(null));
                }
                window.busStopMarkers = [];

                // ì²« ë²ˆì§¸ ì •ë¥˜ì†Œ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
                let firstBusStop = window.selectedBusStops[0];
                let firstPosition = new kakao.maps.LatLng(firstBusStop.yPos, firstBusStop.xPos);

                //  ê²€ìƒ‰ëœ ëª¨ë“  ì •ë¥˜ì†Œ ìœ„ì¹˜ì— ë§ˆì»¤ ì¶”ê°€
                window.selectedBusStops.forEach(busStop => {
                    let markerPosition = new kakao.maps.LatLng(busStop.yPos, busStop.xPos);
                    let marker = new kakao.maps.Marker({
                        position: markerPosition,
                        map: kakaoMap
                    });

                    //  ìƒì„±ëœ ë§ˆì»¤ ë°°ì—´ì— ì €ì¥ (í•„ìš”í•˜ë©´ ë‚˜ì¤‘ì— ì§€ìš¸ ìˆ˜ ìˆìŒ)
                    window.busStopMarkers.push(marker);
                });

                // ì²« ë²ˆì§¸ ì •ë¥˜ì†Œë¡œ ì§€ë„ ì´ë™
                smoothPanTo(firstPosition);

                console.log("âœ… ë§ˆì»¤ ì¶”ê°€ ì™„ë£Œ!");
            }
        });

        function smoothPanTo(targetPosition) {
            let moveSpeed = 0.05; // ì´ë™ ì†ë„ ì¡°ì ˆ (0.01 ~ 0.1 ì‚¬ì´ë¡œ ì¡°ì • ê°€ëŠ¥)

            let currentCenter = kakaoMap.getCenter();
            let targetLat = targetPosition.getLat();
            let targetLng = targetPosition.getLng();
            let currentLat = currentCenter.getLat();
            let currentLng = currentCenter.getLng();

            let deltaLat = (targetLat - currentLat) * moveSpeed;
            let deltaLng = (targetLng - currentLng) * moveSpeed;

            function animateMove() {
                currentLat += deltaLat;
                currentLng += deltaLng;

                let newCenter = new kakao.maps.LatLng(currentLat, currentLng);
                kakaoMap.setCenter(newCenter);

                let distance = Math.sqrt(Math.pow(targetLat - currentLat, 2) + Math.pow(targetLng - currentLng, 2));

                if (distance > 0.0001) { // ëª©í‘œ ì§€ì ê³¼ì˜ ê±°ë¦¬ê°€ ì¶©ë¶„í•˜ë©´ ê³„ì† ì´ë™
                    setTimeout(animateMove, 20); // 20msë§ˆë‹¤ ì´ë™ (ì†ë„ ì¡°ì ˆ ê°€ëŠ¥)
                }
            }

            animateMove();
        }
/*------------------------------TEST ---------------------*/

        function createMarkerImage(src, size, options) {
            var markerImage = new kakao.maps.MarkerImage(src, size, options);
            return markerImage;
        }

        // ì¢Œí‘œì™€ ë§ˆì»¤ì´ë¯¸ì§€ë¥¼ ë°›ì•„ ë§ˆì»¤ë¥¼ ìƒì„±í•˜ì—¬ ë¦¬í„´í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
        function createMarker(position, image) {
            var marker = new kakao.maps.Marker({
                position: position,
                image: image
            });

            return marker;
        }


    </script>

</div>
</body>
</html>

