<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>ì •ë¥˜ì¥ ìˆ˜ì •í•˜ê¸°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <style>
        #map {
            height: 400px;
            width: 600px;
        }

        .custom-emoji-icon {
            font-size: 28px;
            line-height: 1;
            text-align: center;
        }
    </style>
</head>
<body>
<h2>ğŸ› ï¸ ì •ë¥˜ì¥ ì •ë³´ ìˆ˜ì •</h2>

<div>
    <label>ì •ë¥˜ì¥ ID ê²€ìƒ‰: <input type="text" id="searchBsId" placeholder="ì˜ˆ: 101001" required></label>
    <button id="fetchBtn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
</div>

<hr>

<div id="map"></div>

<form id="busStopUpdateForm" style="display:none; margin-top:10px;">
    ì •ë¥˜ì¥ ID: <input type="text" id="bsId" readonly><br>
    ì •ë¥˜ì¥ ì´ë¦„: <input type="text" id="bsNm" required><br>
    ìœ„ë„ (Y): <input type="text" id="ypos" required><br>
    ê²½ë„ (X): <input type="text" id="xpos" required><br>
    <button type="submit">ì •ë¥˜ì¥ ìˆ˜ì •</button>
</form>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    const map = L.map('map').setView([35.8714, 128.6014], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);

    let selectedMarker = null;

    // ğŸ” ì •ë¥˜ì¥ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    document.getElementById("fetchBtn").addEventListener("click", async () => {
        const bsId = document.getElementById("searchBsId").value.trim();
        if (!bsId) return alert("ì •ë¥˜ì¥ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”");

        try {
            const res = await fetch(`/api/bus/busStop?bsId=${bsId}`);
            if (!res.ok) return alert("ì •ë¥˜ì¥ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            const data = await res.json();
            document.getElementById("busStopUpdateForm").style.display = "block";

            // í¼ì— ê°’ ì±„ìš°ê¸°
            document.getElementById("bsId").value = data.bsId;
            document.getElementById("bsNm").value = data.bsNm;
            document.getElementById("xpos").value = data.xpos;
            document.getElementById("ypos").value = data.ypos;

            const lat = data.ypos;
            const lng = data.xpos;

            if (selectedMarker) map.removeLayer(selectedMarker);
            selectedMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-emoji-icon',
                    iconSize: [30, 40],
                    iconAnchor: [15, 40]
                })
            }).addTo(map).bindPopup("ğŸ“ ìˆ˜ì • ëŒ€ìƒ ì •ë¥˜ì¥").openPopup();

            map.setView([lat, lng], 17);
        } catch (err) {
            console.error(err);
            alert("ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
        }
    });

    // ğŸ–±ï¸ ì§€ë„ í´ë¦­ ì‹œ ì¢Œí‘œ ê°±ì‹ 
    map.on("click", (e) => {
        const {lat, lng} = e.latlng;
        document.getElementById("ypos").value = lat;
        document.getElementById("xpos").value = lng;

        if (selectedMarker) map.removeLayer(selectedMarker);
        selectedMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'custom-emoji-icon',
                iconSize: [30, 40],
                iconAnchor: [15, 40]
            })
        }).addTo(map).bindPopup("ğŸ“ ìˆ˜ì • ìœ„ì¹˜ ì„ íƒ").openPopup();
    });

    // âœï¸ ìˆ˜ì • ì œì¶œ
    document.getElementById("busStopUpdateForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const bsId = document.getElementById("bsId").value;
        const bsNm = document.getElementById("bsNm").value;
        const xpos = parseFloat(document.getElementById("xpos").value);
        const ypos = parseFloat(document.getElementById("ypos").value);

        const payload = {bsNm, xpos, ypos};

        try {
            const res = await fetch(`/api/bus/updateStop/${bsId}`, {
                method: "PUT",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert("âœ… ì •ë¥˜ì¥ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
            } else {
                const error = await res.json();
                alert("ìˆ˜ì • ì‹¤íŒ¨: " + (error.message || "ì˜¤ë¥˜ ë°œìƒ"));
            }
        } catch (err) {
            console.error("ìˆ˜ì • ìš”ì²­ ì˜¤ë¥˜:", err);
            alert("ìˆ˜ì • ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
        }
    });
</script>

</body>
</html>
