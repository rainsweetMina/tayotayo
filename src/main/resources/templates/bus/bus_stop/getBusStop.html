<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì •ë¥˜ì¥ ê²€ìƒ‰ ë° ìƒì„¸ë³´ê¸°</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    #map {
      height: 400px;
      margin-top: 20px;
    }

    #resultList {
      list-style: none;
      padding: 0;
    }

    #resultList li {
      cursor: pointer;
      padding: 4px;
      border-bottom: 1px solid #ddd;
    }

    #resultList li:hover {
      background-color: #f0f0f0;
    }

    #detail p {
      margin: 2px 0;
    }
  </style>
</head>
<body>

<h2>ğŸšŒ ì •ë¥˜ì¥ ê²€ìƒ‰</h2>

<input type="text" id="searchInput" placeholder="ì •ë¥˜ì¥ ì´ë¦„ ì…ë ¥ (ì˜ˆ: ê²½ë¶ëŒ€)" style="width: 300px;" oninput="searchBusStops(this.value)">
<ul id="resultList"></ul>

<hr>

<div id="detail" style="display:none;">
  <h3>ğŸ“ ì •ë¥˜ì¥ ìƒì„¸ì •ë³´</h3>
  <p><strong>ID:</strong> <span id="bsId"></span></p>
  <p><strong>ì´ë¦„:</strong> <span id="bsNm"></span></p>
  <p><strong>ìœ„ë„(Y):</strong> <span id="ypos"></span></p>
  <p><strong>ê²½ë„(X):</strong> <span id="xpos"></span></p>
  <p><strong>ì‹œ/ë„:</strong> <span id="city"></span></p>
  <p><strong>êµ¬/êµ°:</strong> <span id="district"></span></p>
  <p><strong>ë™:</strong> <span id="neighborhood"></span></p>
  <p><strong>ë„ì°© ë…¸ì„ :</strong></p>
  <ul id="routes" style="padding-left: 1rem;"></ul>
  <button onclick="deleteBusStop()">ğŸ—‘ï¸ ì •ë¥˜ì¥ ì‚­ì œ</button>
  <button onclick="updateBusStop()">âœï¸ ì •ë¥˜ì¥ ìˆ˜ì •</button>
</div>


<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([35.8714, 128.6014], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
  }).addTo(map);

  let marker = null;

  async function searchBusStops(keyword) {
    if (!keyword.trim()) {
      document.getElementById("resultList").innerHTML = "";
      return;
    }

    const res = await fetch(`/api/bus/searchBS?keyword=${encodeURIComponent(keyword)}`);
    const data = await res.json();

    const resultList = document.getElementById("resultList");
    resultList.innerHTML = "";

    data.forEach(stop => {
      const li = document.createElement("li");
      li.textContent = `${stop.bsNm} (${stop.bsId})`;
      li.addEventListener("click", () => fetchBusStopDetail(stop.bsId));
      resultList.appendChild(li);
    });
  }

  async function fetchBusStopDetail(bsId) {
    const res = await fetch(`/api/bus/busStop?bsId=${bsId}`);
    if (!res.ok) {
      alert("ì •ë¥˜ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const data = await res.json();

    // âœ… ìƒì„¸ ì •ë³´ í‘œì‹œ
    document.getElementById("detail").style.display = "block";
    document.getElementById("bsId").textContent = data.bsId;
    document.getElementById("bsNm").textContent = data.bsNm;
    document.getElementById("xpos").textContent = data.xpos;
    document.getElementById("ypos").textContent = data.ypos;

    // âœ… ì‹œ/ë„, êµ¬/êµ°, ë™ í‘œì‹œ
    document.getElementById("city").textContent = data.city || "-";
    document.getElementById("district").textContent = data.district || "-";
    document.getElementById("neighborhood").textContent = data.neighborhood || "-";

    // âœ… ë…¸ì„  ì •ë³´
    const routeList = document.getElementById("routes");
    routeList.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

    (data.routes || []).forEach(r => {
      const li = document.createElement("li");
      li.innerHTML = `<strong>${r.routeNo}</strong> <small style="color: gray;">(${r.routeNote || "ë°©ë©´ ì •ë³´ ì—†ìŒ"})</small>`;
      routeList.appendChild(li);
    });

    if (data.routes.length === 0) {
      routeList.innerHTML = "<li>ë…¸ì„  ì •ë³´ ì—†ìŒ</li>";
    }


    // âœ… ì§€ë„ ë§ˆì»¤ ê°±ì‹ 
    if (marker) map.removeLayer(marker);
    marker = L.marker([data.ypos, data.xpos])
            .addTo(map)
            .bindPopup(`<strong>${data.bsNm}</strong>`)
            .openPopup();
    map.setView([data.ypos, data.xpos], 17);
  }

</script>
<script>
  async function deleteBusStop() {
    const bsId = document.getElementById("bsId").textContent;

    if (!confirm(`ì •ë§ë¡œ ì •ë¥˜ì¥ [${bsId}]ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    try {
      const res = await fetch(`/api/bus/deleteBusStop?bsId=${bsId}`, {
        method: "DELETE"
      });

      if (res.ok) {
        alert("âœ… ì •ë¥˜ì¥ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        document.getElementById("detail").style.display = "none";
        document.getElementById("resultList").innerHTML = "";
        if (marker) map.removeLayer(marker);
      } else {
        const err = await res.text();
        alert("âŒ ì‚­ì œ ì‹¤íŒ¨: " + err);
      }
    } catch (e) {
      console.error("ì‚­ì œ ì˜¤ë¥˜:", e);
      alert("âŒ ì‚­ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

</script>
<script>
  function updateBusStop() {
    const bsId = document.getElementById("bsId").textContent; // ë˜ëŠ” value
    if (!bsId) {
      alert("ì •ë¥˜ì¥ IDê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬
    window.location.href = `/UpdateBusStop?bsId=${encodeURIComponent(bsId)}`;
  }
</script>
<script>
  window.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    const bsId = params.get("bsId");
    if (bsId) {
      fetchBusStopDetail(bsId);
    }
  });
</script>

</body>
</html>
