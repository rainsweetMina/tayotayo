<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë…¸ì„ ì— ì •ë¥˜ì†Œ ì‚½ì…</title>
</head>
<body>
<h1>ë…¸ì„ ì— ì •ë¥˜ì†Œ ì‚½ì… (ì‹œê°í™”ë¥¼ ìœ„í•œ ì§€ë„ëŠ” 2ì°¨ë•Œ ì‚½ì… ì˜ˆì •)</h1>

<form id="insertForm">
    <label>ë…¸ì„  ID:
        <input type="text" name="routeId" id="routeIdInput" required onblur="loadRouteLinks()">
    </label><br>

    <label>ë°©í–¥ (0: ì—­ë°©í–¥, 1: ì •ë°©í–¥):
        <select name="moveDir">
            <option value="1">ì •ë°©í–¥ (1)</option>
            <option value="0">ì—­ë°©í–¥ (0)</option>
        </select>
    </label><br>

    <label>ì‚½ì…í•  ìˆœì„œ (seq):
        <input type="number" name="seq" min="1" required>
    </label><br>

    <label>ì •ë¥˜ì†Œ ID (bsId):
        <input type="text" name="bsId" required>
    </label><br>

    <button type="submit">ì •ë¥˜ì†Œ ì‚½ì…</button>
</form>

<hr>

<h2>ğŸ“ í˜„ì¬ ë…¸ì„  ì •ë¥˜ì¥ ëª©ë¡</h2>
<table border="1">
    <thead>
    <tr>
        <th>SEQ</th>
        <th>ì •ë¥˜ì†Œ ID</th>
        <th>ì •ë¥˜ì†Œ ì´ë¦„</th>
        <th>ë°©í–¥ (moveDir)</th>
    </tr>
    </thead>
    <tbody id="routeLinkTableBody">
    <tr><td colspan="4">ë…¸ì„  IDë¥¼ ì…ë ¥í•˜ë©´ ì •ë¥˜ì¥ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</td></tr>
    </tbody>
</table>

<script>
    document.getElementById('insertForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;

        const payload = {
            routeId: form.routeId.value.trim(),
            moveDir: form.moveDir.value,
            seq: parseInt(form.seq.value),
            bsId: form.bsId.value.trim()
        };

        try {
            const res = await fetch('/api/bus/InsertStop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await res.json();

            if (res.ok) {
                alert("âœ… ì •ë¥˜ì†Œ ì‚½ì… ì™„ë£Œ!");
                form.reset();
                loadRouteLinks(); // ì‚½ì… í›„ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
            } else {
                alert("ğŸš« ì˜¤ë¥˜ ë°œìƒ: " + data.message);
            }
        } catch (err) {
            console.error(err);
            alert("âŒ ì„œë²„ ìš”ì²­ ì‹¤íŒ¨");
        }
    });

    async function loadRouteLinks() {
        const routeId = document.getElementById('routeIdInput').value.trim();
        if (!routeId) return;

        const tbody = document.getElementById("routeLinkTableBody");
        tbody.innerHTML = "";

        try {
            const res = await fetch(`/api/bus/bus-route-Custom?routeId=${routeId}`);
            if (!res.ok) throw new Error("ë°ì´í„° ì—†ìŒ");

            const data = await res.json();

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4">ì •ë¥˜ì¥ ì •ë³´ ì—†ìŒ</td></tr>`;
                return;
            }

            data.sort((a, b) => a.moveDir.localeCompare(b.moveDir) || a.seq - b.seq); // moveDir, seq ìˆœ ì •ë ¬

            for (const stop of data) {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${stop.seq}</td>
                    <td>${stop.bsId}</td>
                    <td>${stop.bsNm ?? "-"}</td>
                    <td>${stop.moveDir}</td>
                `;
                tbody.appendChild(row);
            }

        } catch (e) {
            tbody.innerHTML = `<tr><td colspan="4">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</td></tr>`;
        }
    }
</script>
</body>
</html>
