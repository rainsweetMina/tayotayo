<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë…¸ì„  ì •ë¥˜ì†Œ ë¦¬ìŠ¤íŠ¸</title>
</head>
<body>
<h1>ë…¸ì„  ì •ë¥˜ì†Œ ì¶œë ¥</h1>

<label>ë…¸ì„  ID ì…ë ¥: <input type="text" id="routeIdInput" placeholder="ì˜ˆ: 36008429002"></label>
<button onclick="loadBusStops()">ë¶ˆëŸ¬ì˜¤ê¸°</button>

<hr>

<!-- âœ… ë…¸ì„  ì •ë³´ í‘œì‹œ ì˜ì—­ -->
<h2>ë…¸ì„  ì •ë³´</h2>
<div id="routeInfoBox">
    <p><strong>ë…¸ì„  ID:</strong> <span id="routeId">-</span></p>
    <p><strong>ë…¸ì„  ë²ˆí˜¸:</strong> <span id="routeNo">-</span></p>
    <p><strong>ì¶œë°œ ì •ë¥˜ì†Œ:</strong> <span id="stNm">-</span> (<span id="stBsId">-</span>)</p>
    <p><strong>ë„ì°© ì •ë¥˜ì†Œ:</strong> <span id="edNm">-</span> (<span id="edBsId">-</span>)</p>
    <p><strong>ë…¸ì„  ì„¤ëª…:</strong> <span id="routeNote">-</span></p>
    <p><strong>ë°ì´í„° ì—°ê²° ì—¬ë¶€:</strong> <span id="dataconnareacd">-</span></p>
    <p><strong>ì •ë°©í–¥ ì„¤ëª…:</strong> <span id="dirRouteNote">-</span></p>
    <p><strong>ì—­ë°©í–¥ ì„¤ëª…:</strong> <span id="ndirRouteNote">-</span></p>
    <p><strong>ë…¸ì„  íƒ€ì… ì½”ë“œ:</strong> <span id="routeTCd">-</span></p>
</div>

<div style="margin-top: 15px;">
    <button id="deleteRouteBtn" style="background-color:red; color:white; font-weight:bold;">
        ğŸš« ë…¸ì„  ì‚­ì œ
    </button>

    <button id="editRouteBtn" style="background-color:orange; color:white; font-weight:bold; margin-left: 10px;"
            onclick="editRoute()">
        âœï¸ ë…¸ì„  ì •ë³´ ìˆ˜ì •
    </button>

</div>

<hr>

<!-- âœ… ì •ë¥˜ì†Œ ëª©ë¡ í…Œì´ë¸” -->
<table border="1" id="resultTable">
    <thead>
    <tr>
        <th>seq</th>
        <th>ë°©í–¥ (moveDir)</th>
        <th>ì •ë¥˜ì†Œ ID</th>
        <th>ì •ë¥˜ì†Œ ì´ë¦„</th>
        <th>ì¢Œí‘œ (x, y)</th>
        <th>ê´€ë¦¬</th>
    </tr>
    </thead>
    <tbody id="tableBody">
    <!-- ê²°ê³¼ ë°ì´í„° ì‚½ì… -->
    </tbody>
</table>


<!-- âœ… ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    async function loadBusStops() {
        const routeId = document.getElementById('routeIdInput').value.trim();
        if (!routeId) {
            alert('ë…¸ì„  IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return;
        }

        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        // ë…¸ì„  ê¸°ë³¸ ì •ë³´ ì¡°íšŒ
        try {
            const res = await fetch(`/api/bus/getRouteInfo?routeId=${routeId}`);
            if (res.ok) {
                const route = await res.json();
                document.getElementById("routeId").textContent = route.routeId || "-";
                document.getElementById("routeNo").textContent = route.routeNo || "-";
                document.getElementById("stBsId").textContent = route.stBsId || "-";
                document.getElementById("edBsId").textContent = route.edBsId || "-";
                document.getElementById("stNm").textContent = route.stNm || "-";
                document.getElementById("edNm").textContent = route.edNm || "-";
                document.getElementById("routeNote").textContent = route.routeNote || "-";
                document.getElementById("dataconnareacd").textContent = route.dataconnareacd || "-";
                document.getElementById("dirRouteNote").textContent = route.dirRouteNote || "-";
                document.getElementById("ndirRouteNote").textContent = route.ndirRouteNote || "-";
                document.getElementById("routeTCd").textContent = route.routeTCd || "-";
            } else {
                console.warn("ë…¸ì„  ì •ë³´ ì—†ìŒ");
            }
        } catch (err) {
            console.error("ë…¸ì„  ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:", err);
        }

        let data = null;

        //  1ì°¨ ì‹œë„: ì¼ë°˜ ë…¸ì„ 
        try {
            const res = await fetch(`/api/bus/bus-route?routeId=${routeId}`);
            if (res.ok) {
                data = await res.json();
            }
        } catch (err) {
            console.warn("ì¼ë°˜ ë…¸ì„  ì¡°íšŒ ì‹¤íŒ¨, ì»¤ìŠ¤í…€ìœ¼ë¡œ ì‹œë„");
        }

        //  2ì°¨ ì‹œë„: ì»¤ìŠ¤í…€ ë…¸ì„ 
        if (!data) {
            try {
                const res = await fetch(`/api/bus/bus-route?routeId=${routeId}`);
                if (res.ok) {
                    data = await res.json();
                }
            } catch (err) {
                console.error("ì»¤ìŠ¤í…€ ë…¸ì„ ë„ ì¡°íšŒ ì‹¤íŒ¨:", err);
            }
        }

        // ì •ë¥˜ì†Œ ëª©ë¡ í…Œì´ë¸” ì¶œë ¥
        if (data && data.length > 0) {
            const routeId = document.getElementById('routeIdInput').value.trim();

            const tbody = document.getElementById("tableBody");
            tbody.innerHTML = "";

            // moveDir ë³„ ìµœëŒ€ seq ê³„ì‚°
            const maxSeq = {
                "0": Math.max(...data.filter(s => s.moveDir === "0").map(s => s.seq)),
                "1": Math.max(...data.filter(s => s.moveDir === "1").map(s => s.seq))
            };

            data.forEach(stop => {
                const isStart = stop.moveDir === "1" && stop.seq === 1;
                const isEnd = stop.seq === maxSeq[stop.moveDir];
                const isProtected = isStart || isEnd;

                const row = document.createElement("tr");
                row.innerHTML = `
            <td>${stop.seq}</td>
            <td>${stop.moveDir}</td>
            <td>${stop.bsId}</td>
            <td>${stop.bsNm ?? '-'}</td>
            <td>${stop.xPos}, ${stop.yPos}</td>
            <td>
                ${isProtected
                    ? `<span style="color: gray;">ğŸ”’ ë³´í˜¸ë¨</span>`
                    : `<button onclick="deleteStop('${routeId}', '${stop.moveDir}', ${stop.seq})">ì‚­ì œ</button>`
                }
            </td>
        `;
                tbody.appendChild(row);
            });
        } else {
            const row = document.createElement("tr");
            row.innerHTML = `<td colspan="5">í•´ë‹¹ ë…¸ì„  IDë¡œ ì¡°íšŒëœ ì •ë¥˜ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</td>`;
            tbody.appendChild(row);
        }
    }
</script>
<script>
    async function deleteStop(routeId, moveDir, seq) {
        if (!confirm(`ì •ë¥˜ì†Œ seq ${seq} (${moveDir === "1" ? "ì •ë°©í–¥" : "ì—­ë°©í–¥"}) ì„ ì‚­ì œí• ê¹Œìš”?`)) return;

        try {
            const res = await fetch(`/api/bus/delete-stop?routeId=${routeId}&moveDir=${moveDir}&seq=${seq}`, {
                method: 'DELETE'
            });

            if (res.ok) {
                alert("ì‚­ì œ ì„±ê³µ!");
                loadBusStops(); // ìƒˆë¡œê³ ì¹¨
            } else {
                const err = await res.text();
                alert("ì‚­ì œ ì‹¤íŒ¨: " + err);
            }
        } catch (e) {
            alert("ì—ëŸ¬ ë°œìƒ: " + e.message);
        }
    }
</script>
<script>
    document.getElementById("deleteRouteBtn").addEventListener("click", async () => {
        const routeId = document.getElementById('routeIdInput').value.trim();
        if (!routeId) {
            alert("ë…¸ì„  IDë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        if (!confirm(`â—ì •ë§ë¡œ ë…¸ì„  [${routeId}] ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;

        try {
            const res = await fetch(`/api/bus/deleteRoute?routeId=${routeId}`, {
                method: 'DELETE'
            });

            if (res.ok) {
                alert("âœ… ë…¸ì„ ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById("tableBody").innerHTML = "";
                document.getElementById("routeInfoBox").querySelectorAll("span").forEach(span => span.textContent = "-");
                document.getElementById("routeIdInput").value = "";
            } else {
                const err = await res.json();
                alert("âŒ ì‚­ì œ ì‹¤íŒ¨: " + err.message);
            }
        } catch (err) {
            console.error("ì‚­ì œ ì¤‘ ì—ëŸ¬:", err);
            alert("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
        }
    });
</script>
<script>
    function editRoute() {
        const routeId = document.getElementById("routeId").textContent;
        if (!routeId || routeId === "-") {
            alert("ë…¸ì„  IDê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }
        window.location.href = `/UpdateRouteInfo?routeId=${routeId}`;
    }
</script>
<script>
    window.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const routeId = params.get("routeId");

        if (routeId) {
            document.getElementById("routeIdInput").value = routeId;
            loadBusStops();
        }
    });
</script>
</body>
</html>
