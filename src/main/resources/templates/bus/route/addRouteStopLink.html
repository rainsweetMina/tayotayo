<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{admin_page_test/admin_layout/layout.html}" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë²„ìŠ¤ ë…¸ì„  ì¶”ê°€</title>
</head>

<div layout:fragment="content" style="">


<body>
<h1>ë²„ìŠ¤ ë…¸ì„  ì¶”ê°€í•˜ê¸°</h1>

<!-- ğŸ” ê²€ìƒ‰ ê¸°ëŠ¥ ì˜ì—­ -->
<div>
    <label for="searchInput">ì •ë¥˜ì¥ ë˜ëŠ” ë…¸ì„  ê²€ìƒ‰:</label>
    <input type="text" id="searchInput" placeholder="ì˜ˆ: 623, ë™ì„±ë¡œ">
    <button type="button" onclick="searchBus()">ê²€ìƒ‰</button>
</div>

<hr>

<form id="busForm">
    <h2>ë…¸ì„  ê¸°ë³¸ ì •ë³´</h2>
    Route ID: <input type="text" name="routeId" required><br>
    Route No: <input type="text" name="routeNo" required><br>
    ì¶œë°œ ì •ë¥˜ì†Œ ID: <input type="text" name="stBsId" oninput="fetchStopName(this)" required><br>
    ë„ì°© ì •ë¥˜ì†Œ ID: <input type="text" name="edBsId" oninput="fetchStopName(this)" required><br>
    ì¶œë°œ ì •ë¥˜ì†Œëª…: <input type="text" name="stNm" readonly disabled><br>
    ë„ì°© ì •ë¥˜ì†Œëª…: <input type="text" name="edNm" readonly disabled><br>
    ë…¸ì„  ì„¤ëª…: <input type="text" name="routeNote"><br>
    ë°ì´í„° ì—°ê²° ì—¬ë¶€: <input type="text" name="dataconnareacd" value="Y"><br>
    ì •ë°©í–¥ ì„¤ëª…: <input type="text" name="dirRouteNote"><br>
    ì—­ë°©í–¥ ì„¤ëª…: <input type="text" name="ndirRouteNote"><br>
    ë…¸ì„  íƒ€ì… ì½”ë“œ: <input type="text" name="routeTCd"><br>

    <hr>

    <h2>ê²½ìœ  ì •ë¥˜ì¥ (ì •ë°©í–¥)</h2>
    <div id="forwardStops" class="direction-block"></div>
    <button type="button" onclick="addStop('forward')">+ ì •ë°©í–¥ ê²½ìœ ì§€ ì¶”ê°€</button>

    <h2>ê²½ìœ  ì •ë¥˜ì¥ (ì—­ë°©í–¥)</h2>
    <div id="backwardStops" class="direction-block"></div>
    <button type="button" onclick="addStop('backward')">+ ì—­ë°©í–¥ ê²½ìœ ì§€ ì¶”ê°€</button>

    <br><br>
    <button type="submit">ë…¸ì„  ë“±ë¡</button>
</form>

<script>
    document.getElementById('busForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const form = e.target;

        const route = {
            routeId: form.routeId.value,
            routeNo: form.routeNo.value,
            stBsId: form.stBsId.value,
            edBsId: form.edBsId.value,
            stNm: form.stNm.value,
            edNm: form.edNm.value,
            routeNote: form.routeNote.value,
            dataconnareacd: form.dataconnareacd.value,
            dirRouteNote: form.dirRouteNote.value,
            ndirRouteNote: form.ndirRouteNote.value,
            routeTCd: form.routeTCd.value
        };

        const stopsForward = Array.from(document.querySelectorAll('#forwardStops .stop-block')).map(block => {
            return {
                bsId: block.querySelector('[name="bsId"]').value,
                moveDir: "1"
            };
        });

        const stopsBackward = Array.from(document.querySelectorAll('#backwardStops .stop-block')).map(block => {
            return {
                bsId: block.querySelector('[name="bsId"]').value,
                moveDir: "0"
            };
        });

        const payload = {
            route: route,
            stopsForward: stopsForward,
            stopsBackward: stopsBackward
        };

        try {
            const res = await fetch('/api/bus/AddBusRoute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert('ë…¸ì„ ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                console.log("ì „ì†¡ ë°ì´í„°:", JSON.stringify(payload, null, 2));
                form.reset();
                document.getElementById("forwardStops").innerHTML = "";
                document.getElementById("backwardStops").innerHTML = "";
            } else {
                const error = await res.json();
                alert('ë“±ë¡ ì‹¤íŒ¨: ' + error.message);
            }
        } catch (err) {
            console.error('ì—ëŸ¬ ë°œìƒ:', err);
            alert('ì—ëŸ¬ ë°œìƒ! ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.');
        }
    });

    function addStop(direction) {
        const container = document.getElementById(direction + 'Stops');
        const idx = container.children.length + 1;

        const newBlock = document.createElement('div');
        newBlock.className = 'stop-block';
        newBlock.innerHTML = `
            <h4>${direction === 'forward' ? 'ì •ë°©í–¥' : 'ì—­ë°©í–¥'} ì •ë¥˜ì¥ ${idx}</h4>
            BS ID: <input type="text" name="bsId" oninput="fetchStopName(this)"><br>
                ì •ë¥˜ì†Œëª…: <input type="text" name="Nm" readonly disabled><br>
            <button type="button" onclick="removeStopBlock(this)">ì‚­ì œ</button>
            <hr>
        `;
        container.appendChild(newBlock);
    }

    function removeStopBlock(button) {
        const block = button.closest('.stop-block');
        block.remove();
    }

    function searchBus() {
        const query = document.getElementById('searchInput').value;
        if (!query.trim()) {
            alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }
        fetch(`/api/bus/searchBSorBN?keyword=${encodeURIComponent(query)}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                console.log("ê²€ìƒ‰ê²°ê³¼:", data);
            })
            .catch(error => console.error('ì˜¤ë¥˜ ë°œìƒ:', error));
    }
</script>

<script>
    function fetchStopName(input) {
        const bsId = input.value.trim();

        if (!bsId) return;

        fetch(`/api/bus/stop-name?bsId=${encodeURIComponent(bsId)}`)
            .then(res => {
                if (!res.ok) throw new Error("not found");
                return res.text();
            })
            .then(name => {
                if (input.name === 'stBsId') {
                    document.querySelector('input[name="stNm"]').value = name;
                } else if (input.name === 'edBsId') {
                    document.querySelector('input[name="edNm"]').value = name;
                } else if (input.name === 'bsId') {
                    const block = input.closest('.stop-block');
                    block.querySelector('input[name="Nm"]').value = name;
                }
            })
            .catch(() => {
                if (input.name === 'stBsId') {
                    document.querySelector('input[name="stNm"]').value = '';
                } else if (input.name === 'edBsId') {
                    document.querySelector('input[name="edNm"]').value = '';
                } else if (input.name === 'bsId') {
                    const block = input.closest('.stop-block');
                    block.querySelector('input[name="Nm"]').value = '';
                }
            });
    }

</script>

</body>
</div>
</html>